version: "3.9"

# Reusable volume list buat live sync kode
x-code-sync: &code_sync
  - ./:/var/www:cached   # kalau Linux bisa hapus :cached -> ./:/var/www
  # cegah folder dependency di container ketiban isi host
  - /var/www/vendor
  - /var/www/node_modules

services:
  # =====================================
  # ğŸ§© Laravel Backend (Main API)
  # =====================================
  backend:
    build:
      context: .
      target: base  # bisa ditambahkan multi-stage nanti
    container_name: twb-be-app
    restart: always
    working_dir: /var/www
    env_file:
      - .env
    ports:
      - "8000:8000"
    environment:
      APP_ENV: ${APP_ENV:-production}
      APP_DEBUG: ${APP_DEBUG:-false}
      DB_HOST: 172.17.0.1    # host DB (service name di compose lain)
      DB_PORT: 5432
    volumes: *code_sync
    command: >
      sh -c "
        echo 'ğŸš€ Starting TWB Backend...' &&
        until nc -z $${DB_HOST} $${DB_PORT}; do echo 'â³ Waiting for MySQL at' $${DB_HOST}:$${DB_PORT}; sleep 3; done &&
        if [ ! -d vendor ]; then
          echo 'ğŸ“¦ vendor not found, running composer install...';
          composer install --no-interaction --prefer-dist --optimize-autoloader;
        fi &&
        php artisan key:generate --force || true &&
        php artisan storage:link || true &&
        php artisan migrate --force || true &&
        echo 'ğŸ”§ Fixing permissions...' &&
        chown -R www-data:www-data storage bootstrap/cache &&
        chmod -R ug+rw storage bootstrap/cache &&
        echo 'ğŸ”¥ Laravel API running on :8000' &&
        php artisan serve --host=0.0.0.0 --port=8000
      "
    networks:
      - chronical-net


networks:
  chronical-net:
    external: true
