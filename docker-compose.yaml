version: "3.9"

# Reusable volume list buat live sync kode
x-code-sync: &code_sync
  - ./:/var/www:cached   # kalau Linux bisa hapus :cached -> ./:/var/www
  # cegah folder dependency di container ketiban isi host
  - /var/www/vendor
  - /var/www/node_modules

services:
  # =====================================
  # üß© Laravel Backend (Main API)
  # =====================================
  backend:
    build: .
    container_name: twb-be-app
    restart: always
    working_dir: /var/www
    env_file:
      - .env
    ports:
      - "8000:8000"
    environment:
      APP_ENV: ${APP_ENV:-production}
      APP_DEBUG: ${APP_DEBUG:-false}
      DB_HOST: ${DB_HOST:-db}     # host DB (service name di compose lain)
      DB_PORT: ${DB_PORT:-3306}
    volumes: *code_sync
    command: >
      sh -c "
        echo 'üöÄ Starting TWB Backend...' &&
        until nc -z $${DB_HOST} $${DB_PORT}; do echo '‚è≥ Waiting for MySQL at' $${DB_HOST}:$${DB_PORT}; sleep 3; done &&
        if [ ! -d vendor ]; then
          echo 'üì¶ vendor not found, running composer install...';
          composer install --no-interaction --prefer-dist --optimize-autoloader;
        fi &&
        php artisan key:generate --force || true &&
        php artisan storage:link || true &&
        php artisan migrate --force || true &&
        echo 'üîß Fixing permissions...' &&
        chown -R www-data:www-data storage bootstrap/cache &&
        chmod -R ug+rw storage bootstrap/cache &&
        echo 'üî• Laravel API running on :8000' &&
        php artisan serve --host=0.0.0.0 --port=8000
      "
    networks:
      - chronical-net

  # =====================================
  # ‚öôÔ∏è Laravel Queue Worker
  # =====================================
  worker:
    build: .
    container_name: twb-be-worker
    restart: always
    working_dir: /var/www
    env_file:
      - .env
    environment:
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-3306}
    volumes: *code_sync
    command: >
      sh -c "
        echo '‚öôÔ∏è Starting Laravel Queue Worker...' &&
        until nc -z $${DB_HOST} $${DB_PORT}; do echo '‚è≥ Waiting for MySQL at' $${DB_HOST}:$${DB_PORT}; sleep 3; done &&
        if [ ! -d vendor ]; then
          echo 'üì¶ vendor not found, running composer install...';
          composer install --no-interaction --prefer-dist --optimize-autoloader;
        fi &&
        php artisan queue:work --sleep=3 --tries=3 --timeout=120
      "
    networks:
      - chronical-net

  # =====================================
  # üì° Dahua Event Listener
  # =====================================
  listener:
    build: .
    container_name: twb-be-listener
    restart: always
    working_dir: /var/www
    env_file:
      - .env
    environment:
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-3306}
    volumes: *code_sync
    command: >
      sh -c "
        echo 'üì° Starting Dahua Event Listener...' &&
        until nc -z $${DB_HOST} $${DB_PORT}; do echo '‚è≥ Waiting for MySQL at' $${DB_HOST}:$${DB_PORT}; sleep 3; done &&
        if [ ! -d vendor ]; then
          echo 'üì¶ vendor not found, running composer install...';
          composer install --no-interaction --prefer-dist --optimize-autoloader;
        fi &&
        php artisan dahua:face-detection-event-listener
      "
    networks:
      - chronical-net

  # =====================================
  # üïí Laravel Scheduler
  # =====================================
  scheduler:
    build: .
    container_name: twb-be-scheduler
    restart: always
    working_dir: /var/www
    env_file:
      - .env
    environment:
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-3306}
    volumes: *code_sync
    command: >
      sh -c "
        echo 'üïí Starting Laravel Scheduler...' &&
        until nc -z $${DB_HOST} $${DB_PORT}; do echo '‚è≥ Waiting for MySQL at' $${DB_HOST}:$${DB_PORT}; sleep 3; done &&
        if [ ! -d vendor ]; then
          echo 'üì¶ vendor not found, running composer install...';
          composer install --no-interaction --prefer-dist --optimize-autoloader;
        fi &&
        php artisan schedule:work
      "
    networks:
      - chronical-net

networks:
  chronical-net:
    external: true
